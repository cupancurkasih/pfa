<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Assistant - CUPK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Main Application -->
    <div id="app">
        <!-- Header -->
        <header>
            <div class="header-container neumorph">
                <div class="logo"><i class="fas fa-coins" style="color: var(--primary-color); margin-right: 10px;"></i> PFA-CUPK</div>
                <div class="user-menu">
                    <div class="user-info">
                        <div class="avatar"><i class="fas fa-user"></i></div>
                        <span id="username-display">{{ current_user.username }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" id="logout-btn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Sidebar -->
            <div class="sidebar neumorph">
                <ul class="nav-menu">
                    <li class="nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="nav-item" data-page="income">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Pendapatan</span>
                    </li>
                    <li class="nav-item" data-page="expense">
                        <i class="fas fa-credit-card"></i>
                        <span>Pengeluaran</span>
                    </li>
                    <li class="nav-item" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Laporan</span>
                    </li>
                </ul>
            </div>

            <!-- Content Area -->
            <div class="content neumorph">
                <!-- Dashboard Page -->
                <div id="dashboard-page">
                    <h2 class="section-title"><i class="fas fa-tachometer-alt" style="margin-right: 10px;"></i> Dashboard Keuangan</h2>
                    
                    <div class="stats-container">
                        <div class="stat-card neumorph">
                            <div class="stat-icon"><i class="fas fa-hand-holding-usd" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i></div>
                            <div class="stat-title">Total Pendapatan Bulan Ini</div>
                            <div class="stat-value">Rp {{ "{:,.0f}".format(total_income|default(0)) }}</div>
                            <div class="stat-desc">
                                {% if total_income > 0 %}
                                <i class="fas fa-arrow-up" style="color: #51cf66;"></i> Pendapatan terkini
                                {% else %}
                                <i class="fas fa-minus" style="color: #6c757d;"></i> Belum ada pendapatan
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="stat-card neumorph">
                            <div class="stat-icon"><i class="fas fa-shopping-bag" style="font-size: 2rem; color: #ff6b6b; margin-bottom: 1rem;"></i></div>
                            <div class="stat-title">Total Pengeluaran Bulan Ini</div>
                            <div class="stat-value">Rp {{ "{:,.0f}".format(total_expense|default(0)) }}</div>
                            <div class="stat-desc">
                                {% if total_expense > 0 %}
                                <i class="fas fa-arrow-up" style="color: #ff6b6b;"></i> Pengeluaran terkini
                                {% else %}
                                <i class="fas fa-minus" style="color: #6c757d;"></i> Belum ada pengeluaran
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="stat-card neumorph">
                            <div class="stat-icon"><i class="fas fa-piggy-bank" style="font-size: 2rem; color: #20c997; margin-bottom: 1rem;"></i></div>
                            <div class="stat-title">Saldo Bulan Ini</div>
                            <div class="stat-value">Rp {{ "{:,.0f}".format(balance|default(0)) }}</div>
                            <div class="stat-desc">
                                <i class="fas fa-percentage" style="color: #20c997;"></i> {{ "{:.0f}".format(balance_percentage|default(0)) }}% dari pendapatan
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-card neumorph">
                            <div class="chart-title"><i class="fas fa-balance-scale" style="margin-right: 8px;"></i> Perbandingan Pendapatan & Pengeluaran</div>
                            <div class="chart-area" id="income-expense-chart">
                                <canvas id="bar-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card neumorph">
                            <div class="chart-title"><i class="fas fa-chart-pie" style="margin-right: 8px;"></i> Distribusi Pengeluaran</div>
                            <div class="chart-area" id="expense-distribution-chart">
                                <canvas id="pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="neumorph" style="padding: 1.5rem;">
                        <h3 class="chart-title"><i class="fas fa-tags" style="margin-right: 8px;"></i> Rekap Kategori Pengeluaran</h3>
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>Kategori</th>
                                    <th>Jumlah</th>
                                    <th>Persentase</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if category_data %}
                                    {% for category in category_data %}
                                    <tr>
                                        <td>
                                            {% if category.category == 'Kebutuhan Pokok' %}
                                                <i class="fas fa-home" style="color: var(--primary-color); margin-right: 10px;"></i>
                                            {% elif category.category == 'Keinginan' %}
                                                <i class="fas fa-coffee" style="color: #ff6b6b; margin-right: 10px;"></i>
                                            {% elif category.category == 'Tabungan/Investasi' %}
                                                <i class="fas fa-chart-line" style="color: #20c997; margin-right: 10px;"></i>
                                            {% elif category.category == 'Amal/Donasi' %}
                                                <i class="fas fa-hand-holding-heart" style="color: #9775fa; margin-right: 10px;"></i>
                                            {% else %}
                                                <i class="fas fa-money-bill-wave" style="color: var(--primary-color); margin-right: 10px;"></i>
                                            {% endif %}
                                            {{ category.category }}
                                        </td>
                                        <td>Rp {{ "{:,.0f}".format(category.amount|default(0)) }}</td>
                                        <td>{{ "{:.1f}".format(category.percentage|default(0)) }}%</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="3" style="text-align: center;">Belum ada data kategori pengeluaran</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Income Page -->
                <div id="income-page" class="hidden">
                    <h2 class="section-title"><i class="fas fa-money-bill-wave" style="margin-right: 10px;"></i> Kelola Pendapatan</h2>
                    
                    <div class="form-container neumorph" style="padding: 1.5rem;">
                        <h3 class="chart-title"><i class="fas fa-plus-circle" style="color: #20c997; margin-right: 8px;"></i> Tambah Data Pendapatan</h3>
                        <form id="income-form">
                            <div class="form-group">
                                <label for="income-category" class="form-label">Kategori</label>
                                <div class="neumorph-inset">
                                    <select id="income-category" class="form-select" required>
                                        <option value="">Pilih Kategori</option>
                                        <option value="Gaji">üíº Gaji</option>
                                        <option value="Bonus">üéÅ Bonus</option>
                                        <option value="Investasi">üí∞ Investasi</option>
                                        <option value="Lain-lain">üîÑ Lain-lain</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="income-desc" class="form-label">Deskripsi</label>
                                <div class="neumorph-inset">
                                    <input type="text" id="income-desc" class="form-input" placeholder="Deskripsi pendapatan" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="income-amount" class="form-label">Jumlah (Rp)</label>
                                <div class="neumorph-inset">
                                    <input type="number" id="income-amount" class="form-input" placeholder="Masukkan jumlah" required min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="income-date" class="form-label">Tanggal</label>
                                <div class="neumorph-inset">
                                    <input type="date" id="income-date" class="form-input" required>
                                </div>
                            </div>
                            
                            <input type="hidden" id="income-id" value="">
                            <button type="submit" id="income-submit-btn" class="btn btn-primary neumorph">Simpan Data</button>
                            <button type="button" id="income-cancel-btn" class="btn neumorph" style="display: none;">Batal</button>
                        </form>
                    </div>
                    
                    <div class="neumorph" style="padding: 1.5rem; margin-top: 1.5rem;">
                        <h3 class="chart-title"><i class="fas fa-list" style="color: var(--primary-color); margin-right: 8px;"></i> Daftar Pendapatan</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Kategori</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="income-table-body">
                                {% if income_data %}
                                    {% for income in income_data %}
                                    <tr>
                                        <td>{{ income.date }}</td>
                                        <td>{{ income.category }}</td>
                                        <td>{{ income.description }}</td>
                                        <td>Rp {{ "{:,.0f}".format(income.amount) }}</td>
                                        <td>
                                            <button class="action-btn edit-btn" data-id="{{ income.id }}"><i class="fas fa-edit"></i></button>
                                            <button class="action-btn delete-btn" data-id="{{ income.id }}"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" style="text-align: center;">Belum ada data pendapatan</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Expense Page -->
                <div id="expense-page" class="hidden">
                    <h2 class="section-title"><i class="fas fa-credit-card" style="margin-right: 10px;"></i> Kelola Pengeluaran</h2>
                    
                    <div class="form-container neumorph" style="padding: 1.5rem;">
                        <h3 class="chart-title"><i class="fas fa-plus-circle" style="color: #ff6b6b; margin-right: 8px;"></i> Tambah Data Pengeluaran</h3>
                        <form id="expense-form">
                            <div class="form-group">
                                <label for="expense-category" class="form-label">Kategori</label>
                                <div class="neumorph-inset">
                                    <select id="expense-category" class="form-select" required>
                                        <option value="">Pilih Kategori</option>
                                        <option value="Kebutuhan Pokok">üè† Kebutuhan Pokok (40%)</option>
                                        <option value="Keinginan">‚òï Keinginan (30%)</option>
                                        <option value="Tabungan/Investasi">üìà Tabungan/Investasi (20%)</option>
                                        <option value="Amal/Donasi">‚ù§Ô∏è Amal/Donasi (10%)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="expense-desc" class="form-label">Deskripsi</label>
                                <div class="neumorph-inset">
                                    <input type="text" id="expense-desc" class="form-input" placeholder="Deskripsi pengeluaran" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="expense-amount" class="form-label">Jumlah (Rp)</label>
                                <div class="neumorph-inset">
                                    <input type="number" id="expense-amount" class="form-input" placeholder="Masukkan jumlah" required min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="expense-date" class="form-label">Tanggal</label>
                                <div class="neumorph-inset">
                                    <input type="date" id="expense-date" class="form-input" required>
                                </div>
                            </div>
                            
                            <input type="hidden" id="expense-id" value="">
                            <button type="submit" id="expense-submit-btn" class="btn btn-primary neumorph">Simpan Data</button>
                            <button type="button" id="expense-cancel-btn" class="btn neumorph" style="display: none;">Batal</button>
                        </form>
                    </div>
                    
                    <div class="neumorph" style="padding: 1.5rem; margin-top: 1.5rem;">
                        <h3 class="chart-title"><i class="fas fa-list" style="color: var(--primary-color); margin-right: 8px;"></i> Daftar Pengeluaran</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Kategori</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="expense-table-body">
                                {% if expense_data %}
                                    {% for expense in expense_data %}
                                    <tr>
                                        <td>{{ expense.date }}</td>
                                        <td>{{ expense.category }}</td>
                                        <td>{{ expense.description }}</td>
                                        <td>Rp {{ "{:,.0f}".format(expense.amount) }}</td>
                                        <td>
                                            <button class="action-btn edit-btn" data-id="{{ expense.id }}"><i class="fas fa-edit"></i></button>
                                            <button class="action-btn delete-btn" data-id="{{ expense.id }}"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" style="text-align: center;">Belum ada data pengeluaran</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reports-page" class="hidden">
                    <h2 class="section-title"><i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Laporan Keuangan</h2>
                    
                    <div class="neumorph" style="padding: 1.5rem;">
                        <div class="filter-controls">
                            <div class="form-group">
                                <label for="report-start-date" class="form-label">Tanggal Mulai</label>
                                <div class="neumorph-inset">
                                    <input type="date" id="report-start-date" class="form-input">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="report-end-date" class="form-label">Tanggal Akhir</label>
                                <div class="neumorph-inset">
                                    <input type="date" id="report-end-date" class="form-input">
                                </div>
                            </div>
                            
                            <button id="generate-report" class="btn btn-primary neumorph">Buat Laporan</button>
                            
                            <div class="export-btns">
                                <button id="export-xls" class="btn neumorph" style="color: #217346;">
                                    <i class="fas fa-file-excel"></i> Export XLS
                                </button>
                                <button id="export-pdf" class="btn neumorph" style="color: #f40f02;">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="charts-container">
                            <div class="chart-card neumorph">
                                <div class="chart-title"><i class="fas fa-chart-line" style="margin-right: 8px;"></i> Tren Pengeluaran Tahunan</div>
                                <div class="chart-area" id="report-chart-container">
                                    <canvas id="report-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="chart-title" style="margin-top: 1.5rem;"><i class="fas fa-bullseye" style="margin-right: 8px;"></i> Perbandingan Alokasi Ideal dan Realisasi</h3>
                        <div class="ratio-container" id="ratio-container">
                            <!-- Ratio boxes will be added here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.7.1/chart.min.js"></script>
    <script>
        // Mendapatkan data chart dari backend dalam format JSON
        const chartData = {{ chart_data_json|safe }};
        const categoryData = {{ category_data_json|safe }};
        
        // Atur tanggal default pada form
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini sebagai default
            const today = new Date().toISOString().split('T')[0];
            
            if (document.getElementById('income-date')) {
                document.getElementById('income-date').value = today;
            }
            
            if (document.getElementById('expense-date')) {
                document.getElementById('expense-date').value = today;
            }
            
            // Tangani navigasi tab
            setupNavigationTabs();
            
            // Tangani form pendapatan
            setupIncomeForm();
            
            // Tangani form pengeluaran
            setupExpenseForm();
            
            // Tangani laporan
            setupReportControls();
            
            // Inisialisasi chart dashboard
            initDashboardCharts();
        });
        
        // Navigasi tab
        function setupNavigationTabs() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    
                    // Update status aktif
                    document.querySelectorAll('.nav-item').forEach(navItem => navItem.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Tampilkan halaman yang dipilih
                    document.querySelectorAll('#dashboard-page, #income-page, #expense-page, #reports-page').forEach(page => {
                        if (page.id === pageName + '-page') {
                            page.classList.remove('hidden');
                        } else {
                            page.classList.add('hidden');
                        }
                    });
                });
            });
        }
        
        // Form pendapatan
        function setupIncomeForm() {
            const form = document.getElementById('income-form');
            const submitBtn = document.getElementById('income-submit-btn');
            const cancelBtn = document.getElementById('income-cancel-btn');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const incomeId = document.getElementById('income-id').value;
                    const date = document.getElementById('income-date').value;
                    const category = document.getElementById('income-category').value;
                    const description = document.getElementById('income-desc').value;
                    const amount = document.getElementById('income-amount').value;
                    
                    if (incomeId) {
                        // Update data yang ada
                        updateIncome(incomeId, date, category, description, amount);
                    } else {
                        // Tambah data baru
                        addIncome(date, category, description, amount);
                    }
                });
                
                // Tambahkan event listener pada tombol batal
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        resetIncomeForm();
                    });
                }
            }
            
            // Tambahkan event listener pada tombol edit dan hapus
            setupIncomeTableActions();
        }
        
        function setupIncomeTableActions() {
            // Edit buttons
            document.querySelectorAll('#income-table-body .edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editIncome(id);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('#income-table-body .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Anda yakin ingin menghapus data ini?')) {
                        deleteIncome(id);
                    }
                });
            });
        }
        
        function addIncome(date, category, description, amount) {
            fetch('/api/add_income', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    category: category,
                    description: description,
                    amount: parseFloat(amount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload halaman untuk melihat perubahan
                    window.location.reload();
                } else {
                    alert('Gagal menyimpan data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menyimpan data.');
            });
        }
        
        function editIncome(id) {
            fetch(`/api/income/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const income = data.income;
                        
                        // Isi form dengan data yang ada
                        document.getElementById('income-id').value = income.id;
                        document.getElementById('income-date').value = income.date;
                        document.getElementById('income-category').value = income.category;
                        document.getElementById('income-desc').value = income.description;
                        document.getElementById('income-amount').value = income.amount;
                        
                        // Ubah teks tombol submit dan tampilkan tombol batal
                        document.getElementById('income-submit-btn').textContent = 'Update Data';
                        document.getElementById('income-cancel-btn').style.display = 'inline-block';
                    } else {
                        alert('Gagal memuat data: ' + (data.error || 'Terjadi kesalahan.'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat memuat data.');
                });
        }
        
        function updateIncome(id, date, category, description, amount) {
            fetch(`/api/update_income/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    category: category,
                    description: description,
                    amount: parseFloat(amount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset form dan reload halaman
                    resetIncomeForm();
                    window.location.reload();
                } else {
                    alert('Gagal memperbarui data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memperbarui data.');
            });
        }
        
        function deleteIncome(id) {
            fetch(`/api/delete_income/${id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload halaman
                    window.location.reload();
                } else {
                    alert('Gagal menghapus data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus data.');
            });
        }
        
        function resetIncomeForm() {
            const form = document.getElementById('income-form');
            form.reset();
            document.getElementById('income-id').value = '';
            document.getElementById('income-submit-btn').textContent = 'Simpan Data';
            document.getElementById('income-cancel-btn').style.display = 'none';
            
            // Set tanggal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('income-date').value = today;
        }
        
        // Form pengeluaran
        function setupExpenseForm() {
            const form = document.getElementById('expense-form');
            const submitBtn = document.getElementById('expense-submit-btn');
            const cancelBtn = document.getElementById('expense-cancel-btn');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const expenseId = document.getElementById('expense-id').value;
                    const date = document.getElementById('expense-date').value;
                    const category = document.getElementById('expense-category').value;
                    const description = document.getElementById('expense-desc').value;
                    const amount = document.getElementById('expense-amount').value;
                    
                    if (expenseId) {
                        // Update data yang ada
                        updateExpense(expenseId, date, category, description, amount);
                    } else {
                        // Tambah data baru
                        addExpense(date, category, description, amount);
                    }
                });
                
                // Tambahkan event listener pada tombol batal
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        resetExpenseForm();
                    });
                }
            }
            
            // Tambahkan event listener pada tombol edit dan hapus
            setupExpenseTableActions();
        }
        
        function setupExpenseTableActions() {
            // Edit buttons
            document.querySelectorAll('#expense-table-body .edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editExpense(id);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('#expense-table-body .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Anda yakin ingin menghapus data ini?')) {
                        deleteExpense(id);
                    }
                });
            });
        }
        
        function addExpense(date, category, description, amount) {
            fetch('/api/add_expense', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    category: category,
                    description: description,
                    amount: parseFloat(amount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload halaman untuk melihat perubahan
                    window.location.reload();
                } else {
                    alert('Gagal menyimpan data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menyimpan data.');
            });
        }
        
        function editExpense(id) {
            fetch(`/api/expense/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const expense = data.expense;
                        
                        // Isi form dengan data yang ada
                        document.getElementById('expense-id').value = expense.id;
                        document.getElementById('expense-date').value = expense.date;
                        document.getElementById('expense-category').value = expense.category;
                        document.getElementById('expense-desc').value = expense.description;
                        document.getElementById('expense-amount').value = expense.amount;
                        
                        // Ubah teks tombol submit dan tampilkan tombol batal
                        document.getElementById('expense-submit-btn').textContent = 'Update Data';
                        document.getElementById('expense-cancel-btn').style.display = 'inline-block';
                    } else {
                        alert('Gagal memuat data: ' + (data.error || 'Terjadi kesalahan.'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat memuat data.');
                });
        }
        
        function updateExpense(id, date, category, description, amount) {
            fetch(`/api/update_expense/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    category: category,
                    description: description,
                    amount: parseFloat(amount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset form dan reload halaman
                    resetExpenseForm();
                    window.location.reload();
                } else {
                    alert('Gagal memperbarui data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memperbarui data.');
            });
        }
        
        function deleteExpense(id) {
            fetch(`/api/delete_expense/${id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload halaman
                    window.location.reload();
                } else {
                    alert('Gagal menghapus data: ' + (data.error || 'Terjadi kesalahan.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus data.');
            });
        }
        
        function resetExpenseForm() {
            const form = document.getElementById('expense-form');
            form.reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-submit-btn').textContent = 'Simpan Data';
            document.getElementById('expense-cancel-btn').style.display = 'none';
            
            // Set tanggal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
        }
        
        // Chart dashboard
        function initDashboardCharts() {
            try {
                // Bar chart - Income vs Expense
                const barChart = new Chart(document.getElementById('bar-chart'), {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Pendapatan',
                                data: chartData.income,
                                backgroundColor: 'rgba(90, 129, 250, 0.6)',
                                borderColor: 'rgba(90, 129, 250, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Pengeluaran',
                                data: chartData.expense,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Rp ' + value.toLocaleString('id-ID');
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Pie chart - Expense Distribution
                if (categoryData && categoryData.length > 0) {
                    const pieLabels = categoryData.map(item => item.category);
                    const pieValues = categoryData.map(item => item.amount);
                    
                    const pieChart = new Chart(document.getElementById('pie-chart'), {
                        type: 'pie',
                        data: {
                            labels: pieLabels,
                            datasets: [{
                                data: pieValues,
                                backgroundColor: [
                                    'rgba(90, 129, 250, 0.8)',
                                    'rgba(255, 99, 132, 0.8)',
                                    'rgba(255, 205, 86, 0.8)',
                                    'rgba(75, 192, 192, 0.8)',
                                    'rgba(153, 102, 255, 0.8)',
                                    'rgba(255, 159, 64, 0.8)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                } else {
                    document.getElementById('expense-distribution-chart').innerHTML = 
                        "<p style='text-align: center; padding: 20px;'>Belum ada data pengeluaran</p>";
                }
            } catch (error) {
                console.error("Error saat membuat chart:", error);
            }
        }
        
        // Report controls
        function setupReportControls() {
            const generateBtn = document.getElementById('generate-report');
            const exportXlsBtn = document.getElementById('export-xls');
            const exportPdfBtn = document.getElementById('export-pdf');
            
            // Set tanggal default
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            
            if (document.getElementById('report-start-date')) {
                document.getElementById('report-start-date').value = firstDay;
            }
            
            if (document.getElementById('report-end-date')) {
                document.getElementById('report-end-date').value = lastDay;
            }
            
            // Generate report
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;
                    
                    if (!startDate || !endDate) {
                        alert('Silakan isi tanggal mulai dan tanggal akhir!');
                        return;
                    }
                    
                    generateReport(startDate, endDate);
                });
            }
            
            // Export to XLS
            if (exportXlsBtn) {
                exportXlsBtn.addEventListener('click', function() {
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;
                    
                    if (!startDate || !endDate) {
                        alert('Silakan isi tanggal mulai dan tanggal akhir untuk mengekspor laporan!');
                        return;
                    }
                    
                    window.location.href = `/export_report/xlsx?start_date=${startDate}&end_date=${endDate}`;
                });
            }
            
            // Export to PDF
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function() {
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;
                    
                    if (!startDate || !endDate) {
                        alert('Silakan isi tanggal mulai dan tanggal akhir untuk mengekspor laporan!');
                        return;
                    }
                    
                    window.location.href = `/export_report/pdf?start_date=${startDate}&end_date=${endDate}`;
                });
            }
            
            // Generate report with default dates
            if (firstDay && lastDay) {
                generateReport(firstDay, lastDay);
            }
        }
        
        function generateReport(startDate, endDate) {
            fetch(`/api/reports?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    // Update chart
                    updateReportChart(data.chart_data);
                    
                    // Update ratio boxes
                    updateRatioBoxes(data.actual_ratio);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat membuat laporan.');
                });
        }
        
        function updateReportChart(chartData) {
            const canvas = document.getElementById('report-chart');
            
            // Destroy existing chart if it exists
            if (window.reportChart) {
                window.reportChart.destroy();
            }
            
            // Create new chart
            window.reportChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Pendapatan',
                            data: chartData.income,
                            fill: false,
                            borderColor: 'rgba(90, 129, 250, 1)',
                            tension: 0.1
                        },
                        {
                            label: 'Pengeluaran',
                            data: chartData.expense,
                            fill: false,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateRatioBoxes(ratioData) {
            const container = document.getElementById('ratio-container');
            container.innerHTML = '';
            
            // Format currency
            const formatCurrency = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            
            // Map kategori ke icon dan warna
            const categoryIcons = {
                'Kebutuhan Pokok': { icon: 'fa-home', color: 'var(--primary-color)' },
                'Keinginan': { icon: 'fa-coffee', color: '#ff6b6b' },
                'Tabungan/Investasi': { icon: 'fa-chart-line', color: '#20c997' },
                'Amal/Donasi': { icon: 'fa-hand-holding-heart', color: '#9775fa' }
            };
            
            // Buat box untuk setiap kategori
            Object.keys(ratioData).forEach(category => {
                const data = ratioData[category];
                const percentage = data.ideal_amount > 0 ? (data.actual_amount / data.ideal_amount * 100) : 0;
                const icon = categoryIcons[category] ? categoryIcons[category].icon : 'fa-money-bill';
                const color = categoryIcons[category] ? categoryIcons[category].color : 'var(--primary-color)';
                
                const box = document.createElement('div');
                box.className = 'ratio-box neumorph';
                box.innerHTML = `
                    <div class="ratio-title"><i class="fas ${icon}" style="color: ${color}; margin-right: 8px;"></i> ${category}</div>
                    <div class="ratio-bar">
                        <div class="ratio-progress" style="width: ${Math.min(percentage, 100)}%; background-color: ${color};"></div>
                    </div>
                    <div class="ratio-value">${formatCurrency.format(data.actual_amount)} (Target: ${formatCurrency.format(data.ideal_amount)})</div>
                `;
                
                container.appendChild(box);
            });
        }
    </script>
</body>
</html>